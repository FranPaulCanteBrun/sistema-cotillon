// Prisma Schema para Cotillón Manager
// Ejecutar: npx prisma generate && npx prisma db push

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== USUARIOS ====================

model User {
  id           String    @id @default(uuid())
  email        String    @unique
  passwordHash String    @map("password_hash")
  name         String
  role         UserRole  @default(SELLER)
  isActive     Boolean   @default(true) @map("is_active")
  lastLoginAt  DateTime? @map("last_login_at")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")

  // Relaciones
  sales          Sale[]
  stockMovements StockMovement[]

  @@map("users")
}

enum UserRole {
  ADMIN
  MANAGER
  SELLER
}

// ==================== CATEGORÍAS ====================

model Category {
  id          String   @id @default(uuid())
  name        String   @unique
  description String?
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relaciones
  products Product[]

  @@map("categories")
}

// ==================== PRODUCTOS ====================

model Product {
  id          String   @id @default(uuid())
  code        String   @unique
  name        String
  description String?
  categoryId  String   @map("category_id")
  supplierId  String?  @map("supplier_id")
  basePrice   Decimal  @map("base_price") @db.Decimal(12, 2)
  minStock    Int      @default(10) @map("min_stock")
  isActive    Boolean  @default(true) @map("is_active")
  imageUrl    String?  @map("image_url")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relaciones
  category Category         @relation(fields: [categoryId], references: [id])
  supplier Supplier?        @relation(fields: [supplierId], references: [id])
  variants ProductVariant[]

  @@index([categoryId])
  @@index([supplierId])
  @@index([code])
  @@map("products")
}

model ProductVariant {
  id           String   @id @default(uuid())
  productId    String   @map("product_id")
  sku          String   @unique
  color        String?
  size         String?
  price        Decimal? @db.Decimal(12, 2)
  currentStock Int      @default(0) @map("current_stock")
  barcode      String?  @unique
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // Relaciones
  product        Product         @relation(fields: [productId], references: [id], onDelete: Cascade)
  saleItems      SaleItem[]
  stockMovements StockMovement[]

  @@index([productId])
  @@index([sku])
  @@index([barcode])
  @@map("product_variants")
}

// ==================== PROVEEDORES ====================

model Supplier {
  id          String   @id @default(uuid())
  name        String   @unique
  contactName String?  @map("contact_name")
  phone       String?
  email       String?
  address     String?
  notes       String?
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relaciones
  products Product[]

  @@map("suppliers")
}

// ==================== CLIENTES ====================

model Customer {
  id             String   @id @default(uuid())
  name           String
  documentNumber String?  @unique @map("document_number")
  phone          String?
  email          String?
  address        String?
  notes          String?
  isActive       Boolean  @default(true) @map("is_active")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  // Relaciones
  sales Sale[]

  @@index([documentNumber])
  @@map("customers")
}

// ==================== MÉTODOS DE PAGO ====================

model PaymentMethod {
  id        String            @id @default(uuid())
  name      String            @unique
  type      PaymentMethodType
  isActive  Boolean           @default(true) @map("is_active")
  config    Json?             @default("{}")
  createdAt DateTime          @default(now()) @map("created_at")
  updatedAt DateTime          @updatedAt @map("updated_at")

  // Relaciones
  sales Sale[]

  @@map("payment_methods")
}

enum PaymentMethodType {
  CASH
  DEBIT
  CREDIT
  TRANSFER
  QR
  OTHER
}

// ==================== VENTAS ====================

model Sale {
  id              String     @id @default(uuid())
  receiptNumber   String     @unique @map("receipt_number")
  userId          String     @map("user_id")
  customerId      String?    @map("customer_id")
  paymentMethodId String     @map("payment_method_id")
  status          SaleStatus @default(PENDING)
  notes           String?
  subtotal        Decimal    @db.Decimal(12, 2)
  discount        Decimal    @default(0) @db.Decimal(12, 2)
  total           Decimal    @db.Decimal(12, 2)
  createdAt       DateTime   @default(now()) @map("created_at")
  updatedAt       DateTime   @updatedAt @map("updated_at")

  // Relaciones
  user           User            @relation(fields: [userId], references: [id])
  customer       Customer?       @relation(fields: [customerId], references: [id])
  paymentMethod  PaymentMethod   @relation(fields: [paymentMethodId], references: [id])
  items          SaleItem[]
  fiscalDocument FiscalDocument?

  @@index([userId])
  @@index([customerId])
  @@index([paymentMethodId])
  @@index([receiptNumber])
  @@index([createdAt])
  @@map("sales")
}

enum SaleStatus {
  PENDING
  COMPLETED
  CANCELLED
  REFUNDED
}

model SaleItem {
  id        String  @id @default(uuid())
  saleId    String  @map("sale_id")
  variantId String  @map("variant_id")
  quantity  Int
  unitPrice Decimal @map("unit_price") @db.Decimal(12, 2)
  discount  Decimal @default(0) @db.Decimal(5, 2) // Porcentaje
  subtotal  Decimal @db.Decimal(12, 2)

  // Relaciones
  sale    Sale           @relation(fields: [saleId], references: [id], onDelete: Cascade)
  variant ProductVariant @relation(fields: [variantId], references: [id])

  @@index([saleId])
  @@index([variantId])
  @@map("sale_items")
}

// ==================== MOVIMIENTOS DE STOCK ====================

model StockMovement {
  id            String            @id @default(uuid())
  variantId     String            @map("variant_id")
  userId        String            @map("user_id")
  type          StockMovementType
  quantity      Int
  previousStock Int               @map("previous_stock")
  newStock      Int               @map("new_stock")
  reason        String?
  referenceId   String?           @map("reference_id") // ID de venta o compra relacionada
  createdAt     DateTime          @default(now()) @map("created_at")

  // Relaciones
  variant ProductVariant @relation(fields: [variantId], references: [id])
  user    User           @relation(fields: [userId], references: [id])

  @@index([variantId])
  @@index([userId])
  @@index([createdAt])
  @@map("stock_movements")
}

enum StockMovementType {
  ENTRY
  SALE
  RETURN
  ADJUSTMENT
  LOSS
}

// ==================== SINCRONIZACIÓN ====================

model SyncLog {
  id        String     @id @default(uuid())
  deviceId  String     @map("device_id")
  operation String
  tableName String     @map("table_name")
  recordId  String     @map("record_id")
  data      Json?
  status    SyncStatus @default(PENDING)
  error     String?
  createdAt DateTime   @default(now()) @map("created_at")
  syncedAt  DateTime?  @map("synced_at")

  @@index([deviceId])
  @@index([status])
  @@index([createdAt])
  @@map("sync_logs")
}

enum SyncStatus {
  PENDING
  SYNCED
  ERROR
  CONFLICT
}

// ==================== FACTURACIÓN ELECTRÓNICA (AFIP/ARCA) ====================

// Cache de Token de Acceso (TA) de WSAA
// Permite persistir el TA entre reinicios del servidor
model FiscalTokenCache {
  id            String   @id @default(uuid())
  env           String   // 'homo' o 'prod'
  cuit          String
  service       String   // 'wsfe'
  token         String   // Token de WSAA (no exponer en logs)
  sign          String   // Sign de WSAA (no exponer en logs)
  expirationTime DateTime @map("expiration_time") // Fecha de expiración del TA
  obtainedAt    DateTime  @map("obtained_at") // Cuándo se obtuvo el TA
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  // Un solo TA por (env, cuit, service)
  @@unique([env, cuit, service])
  @@index([env, cuit, service])
  @@index([expirationTime])
  @@map("fiscal_token_cache")
}

model FiscalDocument {
  id     String @id @default(uuid())
  saleId String @unique @map("sale_id")

  // Datos del emisor (AFIP)
  cuitEmisor String @map("cuit_emisor")
  ptoVta     Int    @map("pto_vta")
  cbteTipo   Int    @map("cbte_tipo") // 11 = Factura C
  cbteNro    Int    @map("cbte_nro")

  // CAE (Código de Autorización Electrónico)
  cae    String? // CAE otorgado por AFIP
  caeVto DateTime? @map("cae_vto") // Fecha de vencimiento del CAE

  // Estado del comprobante
  estado FiscalDocumentStatus @default(PENDING)

  // Errores y observaciones de AFIP (JSON para flexibilidad)
  errores       Json? // Array de errores de AFIP
  observaciones Json? // Observaciones de AFIP

  // Metadatos de la solicitud
  fechaEmision  DateTime  @map("fecha_emision")
  fechaServidor DateTime? @map("fecha_servidor") // Fecha del servidor AFIP

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relaciones
  sale Sale @relation(fields: [saleId], references: [id], onDelete: Cascade)

  // Constraints de idempotencia: evitar duplicados de comprobantes fiscales
  // Un mismo (cuit, ptoVta, cbteTipo, cbteNro) no puede existir dos veces
  @@unique([cuitEmisor, ptoVta, cbteTipo, cbteNro])
  // Índices para búsquedas frecuentes
  @@index([saleId])
  @@index([cuitEmisor, ptoVta, cbteTipo])
  @@index([estado])
  @@index([fechaEmision])
  @@index([createdAt])
  @@map("fiscal_documents")
}

enum FiscalDocumentStatus {
  PENDING // Pendiente de envío a AFIP
  SENT // Enviado a AFIP, esperando respuesta
  AUTHORIZED // Autorizado por AFIP (tiene CAE válido)
  REJECTED // Rechazado por AFIP
  NEEDS_REVIEW // Requiere revisión manual (timeout, error de red, etc.)
}

// ==================== CACHE DE MASTER DATA WSFE ====================

// Cache de parámetros de WSFE (master data) para evitar llamadas innecesarias
// Estos datos cambian raramente, así que los cacheamos en DB
model FiscalMasterDataCache {
  id        String   @id @default(uuid())
  env       String   // 'homo' o 'prod'
  dataType  String   // 'tiposDoc', 'tiposIva', 'tiposMonedas', 'tiposTributos', 'tiposCbte', 'ptosVenta'
  data      Json     // Datos completos del master data (array de objetos)
  cachedAt  DateTime @default(now()) @map("cached_at")
  expiresAt DateTime @map("expires_at") // Cache válido por 24 horas
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Un solo cache por (env, dataType)
  @@unique([env, dataType])
  @@index([env, dataType])
  @@index([expiresAt])
  @@map("fiscal_master_data_cache")
}

// Tracking del estado de puntos de venta en WSFE
model FiscalPtoVtaStatus {
  id           String    @id @default(uuid())
  env          String    // 'homo' o 'prod'
  cuit         String
  status       String    // 'PENDING', 'READY', 'ERROR'
  lastErrorCode Int?     @map("last_error_code") // Último código de error (ej: 602)
  lastErrorMsg  String?  @map("last_error_msg") // Último mensaje de error
  ptosVentaList Json?    @map("ptos_venta_list") // Lista de PV cuando status=READY
  firstSeenAt   DateTime? @map("first_seen_at") // Primera vez que se detectó READY
  firstPendingAt DateTime? @map("first_pending_at") // Primera vez que se detectó PENDING
  lastPendingAt  DateTime? @map("last_pending_at") // Última vez que se detectó PENDING
  attemptCount  Int       @default(0) @map("attempt_count") // Contador de intentos
  lastCheckedAt DateTime  @default(now()) @map("last_checked_at")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  // Un solo registro por (env, cuit)
  @@unique([env, cuit])
  @@index([env, cuit])
  @@index([status])
  @@index([lastCheckedAt])
  @@index([firstPendingAt])
  @@map("fiscal_pto_vta_status")
}

// Configuración fiscal persistida en DB (sobrescribe .env)
// Permite cambiar ptoVta y cuitRepresentado sin reiniciar el servidor
// cuitRepresentado: CUIT que se usa en Auth de WSFE (delegación WSASS)
// Si no está configurado, se usa el CUIT del certificado (env.AFIP_CUIT)
model FiscalConfig {
  id              String   @id @default(uuid())
  env             String   // 'homo' o 'prod'
  cuit            String   // CUIT del certificado (para identificar el registro)
  cuitRepresentado String?  @map("cuit_representado") // CUIT usado en Auth de WSFE (11 dígitos, sin guiones)
  ptoVta          Int?     @map("pto_vta") // Punto de venta configurado (normalizado como número)
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  // Un solo registro por (env, cuit)
  @@unique([env, cuit])
  @@index([env, cuit])
  @@map("fiscal_config")
}

// Auditoría de cambios en configuración fiscal
model FiscalConfigAudit {
  id          String   @id @default(uuid())
  env         String   // 'homo' o 'prod'
  cuit        String
  fieldName   String   @map("field_name") // 'ptoVta'
  oldValue    String?  @map("old_value") // Valor anterior (JSON string)
  newValue    String?   @map("new_value") // Valor nuevo (JSON string)
  changedBy   String?  @map("changed_by") // Usuario que hizo el cambio (si aplica)
  createdAt   DateTime @default(now()) @map("created_at")

  @@index([env, cuit])
  @@index([createdAt])
  @@map("fiscal_config_audit")
}

// Documentos fiscales emitidos (comprobantes autorizados por AFIP)
model FiscalIssuedDocument {
  id                      String   @id @default(uuid())
  env                     String   // 'homo' o 'prod'
  cuit                    String   // CUIT usado en la emisión
  ptoVta                  Int      @map("pto_vta")
  cbteTipo                Int      @map("cbte_tipo") // 11 = Factura C
  cbteNro                 Int      @map("cbte_nro") // Número de comprobante
  cae                     String   // Código de Autorización Electrónico
  caeVto                  DateTime @map("cae_vto") // Fecha de vencimiento del CAE
  impTotal                Decimal  @map("imp_total") @db.Decimal(12, 2) // Importe total
  estado                  String   // 'APPROVED' o 'REJECTED'
  condicionIvaReceptorId  Int?     @map("condicion_iva_receptor_id") // Condición IVA del receptor (obligatorio desde 2025)
  idempotencyKey          String?  @unique @map("idempotency_key") // Clave de idempotencia
  wsfeResponse            Json?    @map("wsfe_response") // Respuesta completa de WSFE (para diagnóstico)
  createdAt               DateTime @default(now()) @map("created_at")
  updatedAt               DateTime @updatedAt @map("updated_at")

  @@unique([env, cuit, ptoVta, cbteTipo, cbteNro])
  @@index([env, cuit, ptoVta])
  @@index([cae])
  @@index([idempotencyKey])
  @@index([createdAt])
  @@map("fiscal_issued_documents")
}
