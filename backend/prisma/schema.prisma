// Prisma Schema para Cotillón Manager
// Ejecutar: npx prisma generate && npx prisma db push

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== USUARIOS ====================

model User {
  id           String    @id @default(uuid())
  email        String    @unique
  passwordHash String    @map("password_hash")
  name         String
  role         UserRole  @default(SELLER)
  isActive     Boolean   @default(true) @map("is_active")
  lastLoginAt  DateTime? @map("last_login_at")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")

  // Relaciones
  sales          Sale[]
  stockMovements StockMovement[]

  @@map("users")
}

enum UserRole {
  ADMIN
  MANAGER
  SELLER
}

// ==================== CATEGORÍAS ====================

model Category {
  id          String   @id @default(uuid())
  name        String   @unique
  description String?
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relaciones
  products Product[]

  @@map("categories")
}

// ==================== PRODUCTOS ====================

model Product {
  id          String   @id @default(uuid())
  code        String   @unique
  name        String
  description String?
  categoryId  String   @map("category_id")
  supplierId  String?  @map("supplier_id")
  basePrice   Decimal  @map("base_price") @db.Decimal(12, 2)
  minStock    Int      @default(10) @map("min_stock")
  isActive    Boolean  @default(true) @map("is_active")
  imageUrl    String?  @map("image_url")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relaciones
  category Category         @relation(fields: [categoryId], references: [id])
  supplier Supplier?        @relation(fields: [supplierId], references: [id])
  variants ProductVariant[]

  @@index([categoryId])
  @@index([supplierId])
  @@index([code])
  @@map("products")
}

model ProductVariant {
  id           String   @id @default(uuid())
  productId    String   @map("product_id")
  sku          String   @unique
  color        String?
  size         String?
  price        Decimal? @db.Decimal(12, 2)
  currentStock Int      @default(0) @map("current_stock")
  barcode      String?  @unique
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // Relaciones
  product        Product         @relation(fields: [productId], references: [id], onDelete: Cascade)
  saleItems      SaleItem[]
  stockMovements StockMovement[]

  @@index([productId])
  @@index([sku])
  @@index([barcode])
  @@map("product_variants")
}

// ==================== PROVEEDORES ====================

model Supplier {
  id          String   @id @default(uuid())
  name        String   @unique
  contactName String?  @map("contact_name")
  phone       String?
  email       String?
  address     String?
  notes       String?
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relaciones
  products Product[]

  @@map("suppliers")
}

// ==================== CLIENTES ====================

model Customer {
  id             String   @id @default(uuid())
  name           String
  documentNumber String?  @unique @map("document_number")
  phone          String?
  email          String?
  address        String?
  notes          String?
  isActive       Boolean  @default(true) @map("is_active")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  // Relaciones
  sales Sale[]

  @@index([documentNumber])
  @@map("customers")
}

// ==================== MÉTODOS DE PAGO ====================

model PaymentMethod {
  id        String            @id @default(uuid())
  name      String            @unique
  type      PaymentMethodType
  isActive  Boolean           @default(true) @map("is_active")
  config    Json?             @default("{}")
  createdAt DateTime          @default(now()) @map("created_at")
  updatedAt DateTime          @updatedAt @map("updated_at")

  // Relaciones
  sales Sale[]

  @@map("payment_methods")
}

enum PaymentMethodType {
  CASH
  DEBIT
  CREDIT
  TRANSFER
  QR
  OTHER
}

// ==================== VENTAS ====================

model Sale {
  id              String     @id @default(uuid())
  receiptNumber   String     @unique @map("receipt_number")
  userId          String     @map("user_id")
  customerId      String?    @map("customer_id")
  paymentMethodId String     @map("payment_method_id")
  status          SaleStatus @default(PENDING)
  notes           String?
  subtotal        Decimal    @db.Decimal(12, 2)
  discount        Decimal    @default(0) @db.Decimal(12, 2)
  total           Decimal    @db.Decimal(12, 2)
  createdAt       DateTime   @default(now()) @map("created_at")
  updatedAt       DateTime   @updatedAt @map("updated_at")

  // Relaciones
  user          User          @relation(fields: [userId], references: [id])
  customer      Customer?     @relation(fields: [customerId], references: [id])
  paymentMethod PaymentMethod @relation(fields: [paymentMethodId], references: [id])
  items         SaleItem[]

  @@index([userId])
  @@index([customerId])
  @@index([paymentMethodId])
  @@index([receiptNumber])
  @@index([createdAt])
  @@map("sales")
}

enum SaleStatus {
  PENDING
  COMPLETED
  CANCELLED
  REFUNDED
}

model SaleItem {
  id         String  @id @default(uuid())
  saleId     String  @map("sale_id")
  variantId  String  @map("variant_id")
  quantity   Int
  unitPrice  Decimal @map("unit_price") @db.Decimal(12, 2)
  discount   Decimal @default(0) @db.Decimal(5, 2) // Porcentaje
  subtotal   Decimal @db.Decimal(12, 2)

  // Relaciones
  sale    Sale           @relation(fields: [saleId], references: [id], onDelete: Cascade)
  variant ProductVariant @relation(fields: [variantId], references: [id])

  @@index([saleId])
  @@index([variantId])
  @@map("sale_items")
}

// ==================== MOVIMIENTOS DE STOCK ====================

model StockMovement {
  id            String            @id @default(uuid())
  variantId     String            @map("variant_id")
  userId        String            @map("user_id")
  type          StockMovementType
  quantity      Int
  previousStock Int               @map("previous_stock")
  newStock      Int               @map("new_stock")
  reason        String?
  referenceId   String?           @map("reference_id") // ID de venta o compra relacionada
  createdAt     DateTime          @default(now()) @map("created_at")

  // Relaciones
  variant ProductVariant @relation(fields: [variantId], references: [id])
  user    User           @relation(fields: [userId], references: [id])

  @@index([variantId])
  @@index([userId])
  @@index([createdAt])
  @@map("stock_movements")
}

enum StockMovementType {
  ENTRY
  SALE
  RETURN
  ADJUSTMENT
  LOSS
}

// ==================== SINCRONIZACIÓN ====================

model SyncLog {
  id        String     @id @default(uuid())
  deviceId  String     @map("device_id")
  operation String
  tableName String     @map("table_name")
  recordId  String     @map("record_id")
  data      Json?
  status    SyncStatus @default(PENDING)
  error     String?
  createdAt DateTime   @default(now()) @map("created_at")
  syncedAt  DateTime?  @map("synced_at")

  @@index([deviceId])
  @@index([status])
  @@index([createdAt])
  @@map("sync_logs")
}

enum SyncStatus {
  PENDING
  SYNCED
  ERROR
  CONFLICT
}

